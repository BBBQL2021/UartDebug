<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UART é€šä¿¡åŠ©æ‰‹ Pro</title>
    <!-- å¼•å…¥ Chart.js ç”¨äºæ•°æ®å¯è§†åŒ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* é»˜è®¤ä¸»é¢˜å˜é‡ */
            --bg-color: #f5f5f7;
            --card-bg: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #86868b;
            --accent-color: #0071e3;
            --accent-hover: #0077ed;
            
            --input-bg: rgba(0,0,0,0.04);
            --border-color: rgba(0,0,0,0.1);
            
            --console-bg: #1e1e20;
            --console-text: #ffffff;
            --console-sys: #a1a1aa;
            
            /* Updated Font Stack for Apple San Francisco look */
            --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", "San Francisco", "Helvetica Neue", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --mono-font: "SF Mono", "Menlo", "Monaco", "Consolas", "Courier New", monospace;
            
            --radius-card: 24px;
            --radius-input: 14px;
            --shadow-card: 0 8px 30px rgba(0, 0, 0, 0.04);
            --shadow-float: 0 10px 40px rgba(0,0,0,0.15);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            margin: 0;
            padding: 24px;
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-stack);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.4s ease;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        header {
            margin-bottom: 20px;
            padding: 0 10px;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left { display: flex; align-items: center; gap: 20px; }
        
        header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        
        /* è§†å›¾åˆ‡æ¢å™¨ (Segmented Control) */
        .view-switcher {
            background: rgba(0,0,0,0.05);
            padding: 4px;
            border-radius: 99px;
            display: flex;
            gap: 4px;
        }
        .view-btn {
            padding: 6px 16px;
            border-radius: 99px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .view-btn.active {
            background: #fff;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’® */
        .theme-btn {
            background: var(--card-bg);
            border: 1px solid rgba(0,0,0,0.05);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .theme-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        /* è§†å›¾å®¹å™¨ */
        .view-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        /* å…·ä½“çš„é¡µé¢ */
        .page-view {
            width: 100%;
            height: 100%;
            display: none; /* é»˜è®¤éšè— */
            animation: fadeIn 0.3s ease;
        }
        .page-view.active {
            display: block; /* æ¿€æ´»æ˜¾ç¤º */
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }

        /* --- ä¸»ç•Œé¢ Grid --- */
        .grid-container {
            display: grid;
            grid-template-columns: 340px 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100%;
        }

        /* --- ç»Ÿè®¡ç•Œé¢ Grid --- */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100%;
            overflow-y: auto;
        }

        /* å¡ç‰‡é€šç”¨æ ·å¼ */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-card);
            padding: 24px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.5);
            position: relative;
        }

        .card-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- ç»Ÿè®¡å¡ç‰‡æ ·å¼ --- */
        .stat-card-row {
            grid-column: 1 / 3;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .mini-stat {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .mini-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        .mini-value { font-size: 24px; font-weight: 700; color: var(--text-primary); margin-top: 5px; font-family: var(--mono-font); }
        .mini-unit { font-size: 12px; color: var(--accent-color); font-weight: 600; }

        /* è¡¨å•æ ·å¼ */
        label { font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; display: block; margin-left: 4px; }
        input[type="text"], input[type="number"], select, textarea {
            background: #ffffff; 
            border: 1px solid #e1e1e3; 
            color: var(--text-primary);
            padding: 10px 14px; 
            border-radius: 18px; /* å¢å¤§åœ†è§’ */
            width: 100%;
            font-family: var(--font-stack); 
            font-size: 14px; 
            transition: all 0.2s ease;
            appearance: none; 
            -webkit-appearance: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
        }
        input:hover, select:hover, textarea:hover {
            border-color: #d1d1d6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        input:focus, select:focus, textarea:focus {
            background: #ffffff; 
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
            outline: none;
        }
        textarea { resize: none; margin-bottom: 16px; }

        /* åˆ†åŒ…è®¾ç½®é¢æ¿ (æ‚¬æµ®é£æ ¼) */
        .config-panel {
            display: none;
            background: #ffffff;
            padding: 16px;
            border-radius: 18px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.12);
            gap: 12px;
            align-items: center;
            position: absolute;
            top: 60px;
            right: 24px;
            z-index: 100;
            border: 1px solid rgba(0,0,0,0.05);
            animation: slideDown 0.2s ease;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç§»é™¤æ•°å­—è¾“å…¥æ¡†çš„ä¸Šä¸‹ç®­å¤´ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* éšè— datalist çš„é»˜è®¤ä¸‹æ‹‰ç®­å¤´ (Chrome/Edge) */
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }

        /* ä¸‹æ‹‰ç®­å¤´ä¿®æ­£ */
        .select-wrapper { position: relative; margin-bottom: 16px; }
        .select-wrapper input, .select-wrapper select { 
            margin-bottom: 0; 
            padding-right: 32px; 
            cursor: pointer; 
            border-radius: var(--radius-input); /* ç¡®ä¿åœ†è§’ */
        }
        .select-arrow { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); pointer-events: none; color: var(--text-secondary); font-size: 12px; }

        /* æŒ‰é’® */
        button { border: none; padding: 12px 24px; border-radius: 999px; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        button:active { transform: scale(0.96); }
        .btn-primary { background-color: var(--accent-color); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-primary:hover { opacity: 0.9; }
        .btn-secondary { background-color: rgba(0,0,0,0.05); color: var(--text-primary); }
        .btn-secondary:hover { background-color: rgba(0,0,0,0.08); }
        .btn-icon-add { width: 28px; height: 28px; padding: 0; border-radius: 50%; background: rgba(0,0,0,0.05); color: var(--accent-color); font-size: 18px; }
        .btn-icon-add:hover { background: rgba(0,0,0,0.1); }

        /* é…ç½®ä¸å¿«æ·æŒ‡ä»¤ */
        .config-area { grid-column: 1 / 2; grid-row: 1 / 3; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; padding-right: 4px; }
        .config-area::-webkit-scrollbar { width: 0; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #d1d1d6; margin-right: 8px; transition: all 0.3s; }
        .status-dot.connected { background-color: #34c759; box-shadow: 0 0 8px rgba(52, 199, 89, 0.5); }
        .status-dot.disconnected { background-color: #ff3b30; }

        /* å‘é€åŒº */
        .send-area { grid-column: 2 / 3; grid-row: 1 / 2; }
        .send-options { display: flex; gap: 20px; margin-bottom: 12px; align-items: center; }
        .checkbox-container { display: flex; align-items: center; font-size: 13px; cursor: pointer; color: var(--text-primary); user-select: none; }
        .checkbox-container input { appearance: none; width: 18px; height: 18px; border: 1px solid #d1d1d6; border-radius: 6px; margin-right: 8px; position: relative; background: #fff; margin-bottom: 0; transition: all 0.2s; }
        .checkbox-container input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .checkbox-container input:checked::after { content: ''; position: absolute; left: 5px; top: 2px; width: 4px; height: 8px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
        .send-toolbar { display: flex; gap: 12px; align-items: flex-end; background: transparent; padding: 12px; border-radius: 18px; }

        /* å¿«æ·æŒ‡ä»¤åˆ—è¡¨ */
        .quick-cmds { flex: 1; min-height: 200px; }
        .cmd-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .cmd-item { background: var(--input-bg); border-radius: 12px; padding: 10px 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .cmd-item:hover { background: rgba(0,0,0,0.08); }
        .cmd-info { flex: 1; overflow: hidden; }
        .cmd-name { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .cmd-val { font-size: 11px; color: var(--text-secondary); font-family: var(--mono-font); margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cmd-del { opacity: 0; transition: opacity 0.2s; background: transparent; color: #ff3b30; padding: 4px;}
        .cmd-item:hover .cmd-del { opacity: 1; }
        .cmd-shortcut { font-size: 10px; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; margin-left: 8px; color: var(--text-secondary); font-family: var(--mono-font); border: 1px solid rgba(0,0,0,0.05); }

        /* æ—¥å¿— */
        .log-area { grid-column: 2 / 3; grid-row: 2 / 3; min-height: 300px; display: flex; flex-direction: column; }
        .log-split-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 12px;
            flex: 1;
            min-height: 0; /* é˜²æ­¢æº¢å‡º */
            margin-top: 10px;
        }
        .log-pane {
            display: flex;
            flex-direction: column;
            background-color: var(--console-bg);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .pane-header {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .log-window { 
            flex: 1; 
            padding: 12px; 
            overflow-y: auto; 
            font-family: var(--mono-font); 
            font-size: 14px;
            line-height: 1.6; 
            color: var(--console-text); 
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3); 
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            font-weight: 500;
        }
        .log-line { 
            display: flex; 
            align-items: baseline; /* åŸºçº¿å¯¹é½ï¼Œç¡®ä¿ä¸åŒå¤§å°æ–‡å­—åº•éƒ¨å¯¹é½ */
            padding: 6px 8px; 
            border-bottom: 1px solid rgba(255,255,255,0.04);
            border-left: 3px solid transparent; /* çŠ¶æ€æŒ‡ç¤ºæ¡ */
            transition: background 0.1s;
            line-height: 1.5;
        }
        .log-line:hover { background: rgba(255,255,255,0.02); }
        
        .log-time { 
            color: rgba(255,255,255,0.3); 
            margin-right: 12px; 
            font-size: 11px; 
            min-width: 155px; /* ç¡®ä¿æ—¶é—´æˆ³åˆ—å®½è¶³å¤Ÿä¸”å›ºå®šï¼Œä¿è¯åç»­å†…å®¹å¯¹é½ */
            user-select: none; 
            font-family: var(--mono-font);
            white-space: nowrap;
        }
        
        .log-content { 
            word-break: break-all; 
            flex: 1; 
            font-family: var(--mono-font);
            font-size: 13px;
        }
        
        .log-icon {
            display: inline-block;
            margin-right: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        /* æ›´åŠ ç‚«é…·çš„ç±»å‹æ ·å¼ */
        .type-rx { 
            border-left-color: #4ade80; 
            background: linear-gradient(90deg, rgba(74, 222, 128, 0.03) 0%, transparent 100%);
        }
        .type-rx .log-content { color: #86efac; text-shadow: 0 0 10px rgba(74, 222, 128, 0.1); }
        
        .type-tx { 
            border-left-color: #60a5fa; 
            background: linear-gradient(90deg, rgba(96, 165, 250, 0.03) 0%, transparent 100%);
        }
        .type-tx .log-content { color: #93c5fd; text-shadow: 0 0 10px rgba(96, 165, 250, 0.1); }
        
        .type-err { 
            border-left-color: #fbbf24; 
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.05) 0%, transparent 100%);
        }
        .type-err .log-content { color: #fcd34d; font-weight: 600; }
        
        .type-sys { 
            border-left-color: var(--console-sys); 
            color: var(--console-sys); 
        }

        /* æ‚¬æµ®çª—ä¸æ¨¡æ€æ¡† */
        .theme-popover { position: absolute; top: 70px; right: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); padding: 16px; border-radius: 20px; box-shadow: var(--shadow-float); z-index: 1000; display: none; width: 280px; border: 1px solid rgba(0,0,0,0.05); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .theme-item { width: 100%; aspect-ratio: 1; border-radius: 12px; cursor: pointer; border: 2px solid rgba(0,0,0,0.05); transition: transform 0.2s; }
        .theme-item:hover { transform: scale(1.1); }
        .theme-item.active { border: 2px solid #333; transform: scale(0.95); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 10000; }
        /* ç¡®ä¿æ·»åŠ æŒ‡ä»¤å¼¹çª—å±‚çº§æ›´é«˜ */
        #addCmdModal { z-index: 20000; }
        
        .modal-content { background: #fff; padding: 24px; border-radius: 24px; width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.2s ease-out; display: flex; flex-direction: column; max-height: 85vh; }
        
        /* æŒ‡ä»¤åº“ç®¡ç†å™¨æ ·å¼ */
        .mgr-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mgr-title { font-size: 18px; font-weight: 700; margin: 0; }
        .mgr-actions { display: flex; gap: 8px; }
        .mgr-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 4px; margin-bottom: 20px; min-height: 200px; }
        .mgr-item { display: flex; align-items: center; background: var(--input-bg); padding: 12px; border-radius: 12px; gap: 12px; }
        .mgr-item-info { flex: 1; min-width: 0; }
        .mgr-item-name { font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 4px; }
        .mgr-item-val { font-family: var(--mono-font); font-size: 12px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .mgr-btn-group { display: flex; gap: 6px; }
        .btn-sm { padding: 6px 12px; font-size: 12px; height: 32px; border-radius: 8px; }
        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; background: rgba(0,0,0,0.05); color: var(--text-secondary); }
        .btn-icon:hover { background: rgba(0,0,0,0.1); color: var(--text-primary); }
        .btn-danger { color: #ff3b30; }
        .btn-danger:hover { background: rgba(255, 59, 48, 0.1); }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.25); }
        #logWindow::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }

        /* Custom Select Styles */
        .custom-select {
            position: relative;
            width: 100%;
        }
        .custom-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            border: 1px solid #e1e1e3;
            border-radius: 18px;
            padding: 10px 14px;
            font-family: var(--font-stack);
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.02);
            user-select: none;
        }
        .custom-select-trigger:hover {
            border-color: #d1d1d6;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .custom-select.open .custom-select-trigger {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
        }
        .custom-select-arrow {
            width: 0; 
            height: 0; 
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-secondary);
            transition: transform 0.2s;
        }
        .custom-select.open .custom-select-arrow {
            transform: rotate(180deg);
        }
        .custom-options {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.05);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 6px;
            max-height: 300px;
            overflow-y: auto;
        }
        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .custom-option {
            padding: 10px 12px;
            font-family: var(--font-stack);
            font-size: 14px;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 10px;
            transition: background 0.1s;
        }
        .custom-option:hover {
            background-color: rgba(0,0,0,0.04);
        }
        .custom-option.selected {
            background-color: rgba(0, 113, 227, 0.08);
            color: var(--accent-color);
            font-weight: 500;
        }
        .custom-select.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        /* --- ä»ªè¡¨ç›˜æ ·å¼ --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding-bottom: 20px;
        }
        
        /* ä¼ æ„Ÿå™¨æ¡ç›® */
        .sensor-item {
            margin-bottom: 20px;
        }
        .sensor-item:last-child { margin-bottom: 0; }
        
        .sensor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 8px;
        }
        
        .sensor-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .sensor-val {
            font-family: var(--mono-font);
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .progress-track {
            height: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            border-radius: 4px;
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* æ•°ç ç®¡æ ·å¼ */
        .digital-display {
            background: #1e1e20;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .digit {
            font-family: 'Courier New', Courier, monospace; /* æ¨¡æ‹Ÿæ•°ç ç®¡ */
            font-size: 48px;
            font-weight: 700;
            color: #ff3b30; /* çº¢è‰²æ•°ç ç®¡ */
            text-shadow: 0 0 10px rgba(255, 59, 48, 0.6);
            background: rgba(0,0,0,0.3);
            padding: 4px 12px;
            border-radius: 4px;
            min-width: 40px;
            text-align: center;
        }

        /* å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        .gpio-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: rgba(0,0,0,0.02);
            border-radius: 16px;
        }
        
        .led-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ddd;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .led-indicator.on {
            background-color: #4ade80;
            box-shadow: 0 0 15px #4ade80, inset 0 2px 5px rgba(255,255,255,0.4);
        }

    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>UART é€šä¿¡åŠ©æ‰‹ <span>Pro</span></h1>
        <!-- è§†å›¾åˆ‡æ¢ -->
        <div class="view-switcher">
            <button class="view-btn active" onclick="switchView('main')">é€šä¿¡ç»ˆç«¯</button>
            <button class="view-btn" onclick="switchView('stats')">æ•°æ®ç»Ÿè®¡</button>
            <button class="view-btn" onclick="switchView('dashboard')">ä¼ æ„Ÿå™¨ä»ªè¡¨ç›˜</button>
        </div>
    </div>
    
    <button class="theme-btn" id="themeToggleBtn">
        <span style="font-size:16px;">&#127912;</span> åˆ‡æ¢èƒŒæ™¯
    </button>
</header>

<div class="theme-popover" id="themePopover">
    <div style="font-size:12px; color:#86868b; margin-bottom:10px; font-weight:600;">é€‰æ‹©é…è‰²æ–¹æ¡ˆ</div>
    <div class="theme-grid" id="themeGrid"></div>
</div>

<!-- é¡µé¢å®¹å™¨ -->
<div class="view-container">
    
    <!-- é¡µé¢ 1: ä¸»è¦é€šä¿¡ç»ˆç«¯ -->
    <div id="view-main" class="page-view active">
        <div class="grid-container">
            <!-- å·¦ä¾§é…ç½® -->
            <div class="config-area">
                <div class="card">
                    <div class="card-title">
                        <span>è®¾å¤‡è¿æ¥</span>
                        <div id="connectionStatus" class="status-dot disconnected"></div>
                    </div>
                    
                    <label>ç«¯å£ (Port)</label>
                    <div class="select-wrapper">
                        <select id="portSelect">
                            <option value="" disabled selected>æ‰«æä¸­...</option>
                        </select>
                        <div class="select-arrow">&#9662;</div>
                    </div>

                    <label>æ³¢ç‰¹ç‡ (Baud Rate)</label>
                    <div class="select-wrapper">
                        <input type="number" id="baudInput" list="baudRates" placeholder="è‡ªå®šä¹‰æˆ–é€‰æ‹©" value="115200">
                        <div class="select-arrow">&#9662;</div>
                    </div>
                    <datalist id="baudRates">
                        <option value="9600"><option value="115200"><option value="921600">
                    </datalist>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>æ•°æ®ä½</label>
                            <div class="select-wrapper">
                                <select id="dataBits">
                                    <option value="8" selected>8</option>
                                    <option value="7">7</option>
                                    <option value="6">6</option>
                                    <option value="5">5</option>
                                </select>
                                <div class="select-arrow">&#9662;</div>
                            </div>
                        </div>
                        <div>
                            <label>åœæ­¢ä½</label>
                            <div class="select-wrapper">
                                <select id="stopBits">
                                    <option value="1" selected>1</option>
                                    <option value="1.5">1.5</option>
                                    <option value="2">2</option>
                                </select>
                                <div class="select-arrow">&#9662;</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label>æ ¡éªŒä½</label>
                            <div class="select-wrapper">
                                <select id="parity">
                                    <option value="None" selected>None</option>
                                    <option value="Even">Even</option>
                                    <option value="Odd">Odd</option>
                                    <option value="Mark">Mark</option>
                                    <option value="Space">Space</option>
                                </select>
                                <div class="select-arrow">&#9662;</div>
                            </div>
                        </div>
                        <div>
                            <label>æµæ§</label>
                            <div class="select-wrapper">
                                <select id="flowControl">
                                    <option value="None" selected>None</option>
                                    <option value="RTS/CTS">RTS/CTS</option>
                                    <option value="XON/XOFF">XON/XOFF</option>
                                </select>
                                <div class="select-arrow">&#9662;</div>
                            </div>
                        </div>
                    </div>

                    <button id="toggleConnectBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">
                        è¿æ¥è®¾å¤‡
                    </button>
                </div>

                <div class="card quick-cmds">
                    <div class="card-title">
                        <span>å¿«æ·æŒ‡ä»¤åº“</span>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-icon-add" onclick="openCmdManager()" title="ç®¡ç†æŒ‡ä»¤åº“" style="font-size: 14px;">â‹®</button>
                            <button class="btn-icon-add" onclick="openAddCmdModal()" title="æ·»åŠ æŒ‡ä»¤">&#43;</button>
                        </div>
                    </div>
                    <div class="cmd-list" id="cmdList">
                        <div style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 40px;">ç‚¹å‡» + å·æ·»åŠ </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§æ“ä½œ -->
            <div class="card send-area">
                <div class="card-title" style="display: flex; gap: 20px; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 12px; margin-bottom: 16px;">
                    <div class="send-tab active" onclick="switchSendTab('basic')" style="cursor: pointer; font-weight: 600;">åŸºæœ¬å‘é€</div>
                    <div class="send-tab" onclick="switchSendTab('protocol')" style="cursor: pointer; color: var(--text-secondary);">åè®®ä¼ è¾“</div>
                </div>

                <!-- Basic Send Tab -->
                <div id="tab-basic" class="send-tab-content">
                    <textarea id="sendInput" rows="3" placeholder="åœ¨æ­¤è¾“å…¥è¦å‘é€çš„æ•°æ®..." style="font-family: var(--mono-font);"></textarea>
                    <div class="send-options">
                        <label class="checkbox-container"><input type="checkbox" id="hexSend"> HEX å‘é€</label>
                        <label class="checkbox-container"><input type="checkbox" id="autoNewline"> è‡ªåŠ¨æ·»åŠ æ¢è¡Œ</label>
                    </div>
                    <div class="send-toolbar">
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
                            <label style="margin:0; font-size: 11px;">å¾ªç¯é—´éš” (æ¯«ç§’)</label>
                            <input type="number" id="autoSendInterval" value="1000" style="margin:0; padding: 6px 12px; height: 32px; background: #fff; border: 1px solid rgba(0,0,0,0.1);">
                        </div>
                        <button id="autoSendBtn" class="btn-secondary">å¾ªç¯å‘é€</button>
                        <button id="sendBtn" class="btn-primary" style="padding-left: 28px; padding-right: 28px;">å‘é€</button>
                    </div>
                </div>

                <!-- Protocol Send Tab -->
                <div id="tab-protocol" class="send-tab-content" style="display: none; height: 100%;">
                    <div class="protocol-container" style="display: flex; gap: 20px; height: 100%;">
                        <!-- RX Parser -->
                        <div class="proto-panel" style="flex: 1; border-right: 1px solid rgba(0,0,0,0.05); padding-right: 20px; display: flex; flex-direction: column; gap: 10px;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">ä»æœºå“åº”è§£æ (RX)</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <div><label style="margin:0 0 4px 0; font-size:11px;">åœ°å€(Hex)</label><input type="text" id="rxAddr" readonly style="padding: 6px;"></div>
                                <div><label style="margin:0 0 4px 0; font-size:11px;">åŠŸèƒ½(Hex)</label><input type="text" id="rxFunc" readonly style="padding: 6px;"></div>
                                <div><label style="margin:0 0 4px 0; font-size:11px;">é•¿åº¦(Dec)</label><input type="text" id="rxLen" readonly style="padding: 6px;"></div>
                                <div><label style="margin:0 0 4px 0; font-size:11px;">åºåˆ—(Dec)</label><input type="text" id="rxSeq" readonly style="padding: 6px;"></div>
                            </div>
                            <div style="margin-top: 4px;">
                                <label style="margin:0 0 4px 0; font-size:11px;">è§£ææ•°æ®</label>
                                <textarea id="rxParsedResult" readonly style="height: 60px; font-size: 12px; font-family: var(--mono-font); padding: 8px;"></textarea>
                            </div>
                        </div>

                        <!-- TX Builder -->
                        <div class="proto-panel" style="flex: 1.5; display: flex; flex-direction: column; gap: 10px;">
                            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary);">ä¸»æœºå‘é€æ„å»º (TX)</div>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <div><label style="margin:0 0 4px 0; font-size:11px;">åœ°å€(Hex)</label><input type="text" id="txAddr" value="01" maxlength="2" style="padding: 6px;"></div>
                                <div><label style="margin:0 0 4px 0; font-size:11px;">åŠŸèƒ½(Hex)</label><input type="text" id="txFunc" value="01" maxlength="2" style="padding: 6px;"></div>
                                <div><label style="margin:0 0 4px 0; font-size:11px;">åºåˆ—(Dec)</label><input type="number" id="txSeq" value="0" style="padding: 6px;"></div>
                                <div>
                                    <label style="margin:0 0 4px 0; font-size:11px;">æ ¡éªŒ</label>
                                    <select id="txCheckMode" style="padding: 6px; font-size: 12px;">
                                        <option value="sum">SUM</option>
                                        <option value="xor">XOR</option>
                                        <option value="crc8">CRC8</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label style="margin:0 0 4px 0; font-size:11px;">æ•°æ®å†…å®¹ (Hex, ç©ºæ ¼åˆ†éš”)</label>
                                <textarea id="txData" rows="2" placeholder="01 02 03..." style="font-family: var(--mono-font); margin-bottom: 8px; font-size: 13px;"></textarea>
                            </div>

                            <div class="send-toolbar" style="margin-top: auto; padding: 8px;">
                                <div style="flex: 1; display: flex; gap: 12px; align-items: center;">
                                    <label class="checkbox-container" style="font-size: 12px; margin: 0;"><input type="checkbox" id="protoAutoSend"> å¾ªç¯</label>
                                    <input type="number" id="protoInterval" value="1000" style="width: 60px; padding: 4px; font-size: 12px; height: 28px;">
                                    <span style="font-size: 11px; color: var(--text-secondary);">ms</span>
                                </div>
                                <button id="protoSendBtn" class="btn-primary" style="padding: 6px 20px; font-size: 13px;">å‘é€</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card log-area">
                <div class="card-title" style="margin-bottom: 0;">
                    <span>ç»ˆç«¯æ§åˆ¶å°</span>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label class="checkbox-container" style="margin: 0;"><input type="checkbox" id="hexShow"> HEX æŸ¥çœ‹</label>
                        <select id="rxEncodingSelect" style="width: auto; padding: 6px 12px; font-size: 12px;">
                            <option value="utf-8" selected>UTF-8</option>
                            <option value="gbk">GBK</option>
                            <option value="ascii">ASCII</option>
                            <option value="latin-1">Latin-1</option>
                        </select>
                        <button class="btn-secondary" style="padding: 6px 14px; font-size: 12px; border-radius: 8px;" onclick="togglePacketConfig()" title="åˆ†åŒ…è®¾ç½®">âš™ï¸</button>
                        <button class="btn-secondary" style="padding: 6px 14px; font-size: 12px; border-radius: 8px;" onclick="clearLog()">æ¸…ç©º</button>
                    </div>
                </div>

                <!-- åˆ†åŒ…è®¾ç½®é¢æ¿ -->
                <div id="packetConfigPanel" class="config-panel">
                    <span style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">RXåˆ†åŒ…:</span>
                    <input type="text" id="rxFrameHeader" placeholder="å¸§å¤´ (Hex)" style="width: 100px;">
                    <input type="text" id="rxFrameTail" placeholder="å¸§å°¾ (Hex)" style="width: 100px;">
                    <label class="checkbox-container" style="margin: 0; font-size: 12px;"><input type="checkbox" id="rxPacketSplit"> å¯ç”¨</label>
                </div>
                
                <div class="log-split-container">
                    <div class="log-pane tx-pane">
                        <div class="pane-header">å‘é€æ—¥å¿— (TX)</div>
                        <div id="logWindowTx" class="log-window">
                             <div class="log-line type-sys">
                                <span class="log-time" id="initTimeTx"></span>
                                <span class="log-content">TX Ready.</span>
                            </div>
                        </div>
                    </div>
                    <div class="log-pane rx-pane">
                        <div class="pane-header">æ¥æ”¶æ—¥å¿— (RX)</div>
                        <div id="logWindowRx" class="log-window">
                             <div class="log-line type-sys">
                                <span class="log-time" id="initTimeRx"></span>
                                <span class="log-content">RX Ready.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢ 2: æ•°æ®ç»Ÿè®¡å¯è§†åŒ– -->
    <div id="view-stats" class="page-view">
        <div class="stats-container">
            <!-- é¡¶éƒ¨å°å¡ç‰‡ -->
            <div class="stat-card-row">
                <div class="mini-stat">
                    <div class="mini-label">æ€»æ¥æ”¶ (RX)</div>
                    <div class="mini-value" id="statRxTotal">0</div>
                    <div class="mini-unit">Bytes</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-label">æ€»å‘é€ (TX)</div>
                    <div class="mini-value" id="statTxTotal">0</div>
                    <div class="mini-unit">Bytes</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-label">æ¥æ”¶åŒ…æ•°</div>
                    <div class="mini-value" id="statRxPackets">0</div>
                    <div class="mini-unit">Packets</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-label">å‘é€åŒ…æ•°</div>
                    <div class="mini-value" id="statTxPackets">0</div>
                    <div class="mini-unit">Packets</div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="card" style="height: 400px;">
                <div class="card-title">é€šä¿¡æµé‡åˆ†å¸ƒ (Bytes)</div>
                <div style="flex:1; position: relative;">
                    <canvas id="trafficPieChart"></canvas>
                </div>
            </div>

            <div class="card" style="height: 400px;">
                <div class="card-title">å®æ—¶ä¼ è¾“é€Ÿç‡ (Bytes/s)</div>
                <div style="flex:1; position: relative;">
                    <canvas id="rateLineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- é¡µé¢ 3: ä¼ æ„Ÿå™¨ä»ªè¡¨ç›˜ -->
    <div id="view-dashboard" class="page-view">
        <div class="dashboard-grid">
            <!-- ADC Sensors -->
            <div class="card">
                <div class="card-title">ç¯å¢ƒä¼ æ„Ÿå™¨ (ADC)</div>
                
                <div class="sensor-item">
                    <div class="sensor-header">
                        <div class="sensor-name"><span style="font-size:18px">ğŸ”Š</span> å£°éŸ³å¼ºåº¦</div>
                        <div class="sensor-val" id="val-sound">45 dB</div>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="bar-sound" style="width: 45%"></div>
                    </div>
                </div>

                <div class="sensor-item">
                    <div class="sensor-header">
                        <div class="sensor-name"><span style="font-size:18px">ğŸ’§</span> åœŸå£¤æ¹¿åº¦</div>
                        <div class="sensor-val" id="val-moisture">60 %</div>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="bar-moisture" style="width: 60%; background-color: #06b6d4;"></div>
                    </div>
                </div>

                <div class="sensor-item">
                    <div class="sensor-header">
                        <div class="sensor-name"><span style="font-size:18px">ğŸ‹ï¸</span> å‹åŠ›ä¼ æ„Ÿå™¨</div>
                        <div class="sensor-val" id="val-pressure">1024</div>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="bar-pressure" style="width: 30%; background-color: #f59e0b;"></div>
                    </div>
                </div>
            </div>

            <!-- IIC Display -->
            <div class="card">
                <div class="card-title">æ•°ç ç®¡æ˜¾ç¤º (IIC)</div>
                <div class="digital-display">
                    <div class="digit" id="digit-0">8</div>
                    <div class="digit" id="digit-1">8</div>
                    <div class="digit" id="digit-2">8</div>
                    <div class="digit" id="digit-3">8</div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="iicInput" placeholder="è¾“å…¥4ä½æ•°å­—" maxlength="4" style="flex:1; padding: 10px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); font-family: var(--mono-font); text-align: center; font-size: 16px;">
                    <button class="btn-primary" onclick="updateIICDisplay()">å‘é€</button>
                </div>
            </div>

            <!-- GPIO Control -->
            <div class="card">
                <div class="card-title">GPIO æ§åˆ¶</div>
                <div class="gpio-control">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div id="ledIndicator" class="led-indicator"></div>
                        <span style="font-weight: 500;">LED çŠ¶æ€æŒ‡ç¤º</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="ledToggle" onchange="toggleLED(this)">
                        <span class="slider round"></span>
                    </label>
                </div>
                <div style="margin-top: 20px; color: var(--text-secondary); font-size: 13px; line-height: 1.6;">
                    <p>è¯´æ˜ï¼š</p>
                    <ul style="padding-left: 20px; margin: 0;">
                        <li>LED å¼€å…³å°†å‘é€ <code>LED:ON</code> æˆ– <code>LED:OFF</code></li>
                        <li>IIC æ•°ç ç®¡å°†å‘é€ <code>DISP:xxxx</code></li>
                        <li>ADC æ•°æ®éœ€è§£ææ ¼å¼ <code>SENSOR:sound,moisture,pressure</code></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- æ¨¡æ€æ¡†: æ·»åŠ /ç¼–è¾‘æŒ‡ä»¤ -->
<div id="addCmdModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin:0 0 20px 0; text-align:center;">æ–°æŒ‡ä»¤</h3>
        <input type="hidden" id="editCmdIndex" value="-1">
        <div style="margin-bottom: 20px;">
            <input type="text" id="newCmdName" placeholder="æŒ‡ä»¤åç§°">
        </div>
        <div style="margin-bottom: 20px;">
            <textarea id="newCmdData" rows="3" placeholder="æ•°æ®å†…å®¹..." style="width: 100%;"></textarea>
        </div>
        <div style="margin-bottom: 20px; position: relative;">
            <input type="text" id="newCmdShortcut" placeholder="ç‚¹å‡»æ­¤å¤„æŒ‰ä¸‹å¿«æ·é”® (å¯é€‰)" readonly style="cursor: pointer; caret-color: transparent; width: 100%; padding-right: 30px;">
            <button onclick="clearShortcut()" title="æ¸…é™¤å¿«æ·é”®" style="position: absolute; right: 4px; top: 50%; transform: translateY(-50%); border: none; background: transparent; color: #999; cursor: pointer; padding: 6px; width: auto; height: auto;">âœ•</button>
        </div>
        <label class="checkbox-container" style="margin: 10px 0 20px 0;">
            <input type="checkbox" id="newCmdHex"> HEX æ ¼å¼
        </label>
        <div style="display: flex; gap: 12px;">
            <button class="btn-secondary" style="flex:1" onclick="closeModal('addCmdModal')">å–æ¶ˆ</button>
            <button class="btn-primary" style="flex:1" onclick="saveCommand()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- æ¨¡æ€æ¡†: æŒ‡ä»¤åº“ç®¡ç† -->
<div id="cmdManagerModal" class="modal">
    <div class="modal-content" style="width: 600px; height: 70vh;">
        <div class="mgr-header">
            <h3 class="mgr-title">æŒ‡ä»¤åº“ç®¡ç†</h3>
            <div class="mgr-actions">
                <button class="btn-secondary btn-sm" onclick="importCommands()">å¯¼å…¥</button>
                <button class="btn-secondary btn-sm" onclick="exportCommands()">å¯¼å‡º</button>
                <button class="btn-icon" onclick="closeModal('cmdManagerModal')" title="å…³é—­">âœ•</button>
            </div>
        </div>
        
        <div class="mgr-list" id="mgrList">
            <!-- æŒ‡ä»¤åˆ—è¡¨å°†åœ¨æ­¤æ¸²æŸ“ -->
        </div>

        <button class="btn-primary" style="width: 100%;" onclick="openAddCmdModal()">+ æ·»åŠ æ–°æŒ‡ä»¤</button>
    </div>
</div>

<input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleFileSelect(event)">

<script>
    // --- ä¸»é¢˜æ•°æ® ---
    const themes = [
        { name: 'Apple Gray', bg: '#f5f5f7', accent: '#0071e3' },
        { name: 'Sakura',     bg: '#fff0f5', accent: '#ff5e7d' },
        { name: 'Mint',       bg: '#e8fdf5', accent: '#10b981' },
        { name: 'Sky',        bg: '#e0f2fe', accent: '#0ea5e9' },
        { name: 'Lemon',      bg: '#fef9c3', accent: '#eab308' },
        { name: 'Lavender',   bg: '#f3e8ff', accent: '#8b5cf6' },
        { name: 'Peach',      bg: '#fff7ed', accent: '#f97316' },
        { name: 'Stone',      bg: '#e7e5e4', accent: '#57534e' },
        { name: 'Rose',       bg: '#ffe4e6', accent: '#f43f5e' },
        { name: 'Ocean',      bg: '#ecfeff', accent: '#06b6d4' },
        { name: 'Lime',       bg: '#ecfccb', accent: '#84cc16' },
        { name: 'Indigo',     bg: '#e0e7ff', accent: '#6366f1' }
    ];

    let ws = null;
    let isConnected = false;
    let autoSendTimer = null;
    let savedCommands = JSON.parse(localStorage.getItem('serial_cmds') || '[]');
    let currentThemeIdx = parseInt(localStorage.getItem('theme_idx') || '0');
    
    // ç»Ÿè®¡æ•°æ®å˜é‡
    let stats = {
        rxBytes: 0,
        txBytes: 0,
        rxPackets: 0,
        txPackets: 0,
        rxBytesSec: 0, // å½“å‰ç§’
        txBytesSec: 0  // å½“å‰ç§’
    };
    
    // Chart å®ä¾‹
    let pieChart = null;
    let lineChart = null;
    let rateInterval = null;

    const dom = {
        ports: document.getElementById('portSelect'),
        baud: document.getElementById('baudInput'),
        dataBits: document.getElementById('dataBits'),
        stopBits: document.getElementById('stopBits'),
        parity: document.getElementById('parity'),
        flowControl: document.getElementById('flowControl'),
        connectBtn: document.getElementById('toggleConnectBtn'),
        statusDot: document.getElementById('connectionStatus'),
        input: document.getElementById('sendInput'),
        isHex: document.getElementById('hexSend'),
        isAutoNewline: document.getElementById('autoNewline'),
        sendBtn: document.getElementById('sendBtn'),
        logTx: document.getElementById('logWindowTx'),
        logRx: document.getElementById('logWindowRx'),
        isHexShow: document.getElementById('hexShow'),
        rxEncoding: document.getElementById('rxEncodingSelect'),
        cmdList: document.getElementById('cmdList'),
        autoSendBtn: document.getElementById('autoSendBtn'),
        interval: document.getElementById('autoSendInterval'),
        themeBtn: document.getElementById('themeToggleBtn'),
        themePopover: document.getElementById('themePopover'),
        themeGrid: document.getElementById('themeGrid'),
        // ç»Ÿè®¡ DOM
        statRxTotal: document.getElementById('statRxTotal'),
        statTxTotal: document.getElementById('statTxTotal'),
        statRxPackets: document.getElementById('statRxPackets'),
        statTxPackets: document.getElementById('statTxPackets')
    };

    // --- è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†é€»è¾‘ ---
    function setupCustomSelect(select) {
        if (select.nextSibling && select.nextSibling.className === 'custom-select') return;
        
        // éšè—åŸ Select
        select.style.display = 'none';
        // éšè—åŸæœ‰çš„ç®­å¤´ (å¦‚æœæ˜¯ .select-wrapper ç»“æ„)
        if (select.parentElement.classList.contains('select-wrapper')) {
             const arrow = select.parentElement.querySelector('.select-arrow');
             if (arrow) arrow.style.display = 'none';
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'custom-select';
        
        // æ’å…¥åˆ° select åé¢
        select.parentNode.insertBefore(wrapper, select.nextSibling);
        
        const trigger = document.createElement('div');
        trigger.className = 'custom-select-trigger';
        
        const arrowIcon = document.createElement('div');
        arrowIcon.className = 'custom-select-arrow';

        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'custom-options';
        
        wrapper.appendChild(trigger);
        trigger.appendChild(arrowIcon); // ç®­å¤´æ”¾åœ¨ trigger å†…éƒ¨ï¼Œä½œä¸ºå­å…ƒç´ 
        wrapper.appendChild(optionsDiv);

        // åˆ·æ–°å‡½æ•°ï¼šåŒæ­¥ Select çŠ¶æ€åˆ°è‡ªå®šä¹‰ UI
        select.refreshCustomSelect = () => {
            const selectedOption = select.options[select.selectedIndex];
            // æ›´æ–° Trigger æ–‡æœ¬ (ä¸è¦†ç›–ç®­å¤´ï¼Œç®­å¤´æ˜¯å­å…ƒç´ ï¼Œæ–‡æœ¬ç›´æ¥ä½œä¸ºæ–‡æœ¬èŠ‚ç‚¹æˆ–æ’å…¥span)
            // ç®€å•å¤„ç†ï¼šæ¸…ç©º trigger å†…å®¹ï¼Œé‡æ–°æ·»åŠ æ–‡æœ¬å’Œç®­å¤´
            trigger.innerHTML = '';
            const textSpan = document.createElement('span');
            textSpan.textContent = selectedOption ? selectedOption.text : 'è¯·é€‰æ‹©';
            trigger.appendChild(textSpan);
            trigger.appendChild(arrowIcon);
            
            optionsDiv.innerHTML = '';
            Array.from(select.options).forEach((opt) => {
                const div = document.createElement('div');
                div.className = 'custom-option' + (opt.selected ? ' selected' : '');
                div.textContent = opt.text;
                div.dataset.value = opt.value;
                div.onclick = (e) => {
                    e.stopPropagation();
                    select.value = opt.value;
                    select.dispatchEvent(new Event('change'));
                    select.refreshCustomSelect(); // é€‰ä¸­ååˆ·æ–°æ˜¾ç¤º
                    wrapper.classList.remove('open');
                };
                optionsDiv.appendChild(div);
            });

            if (select.disabled) wrapper.classList.add('disabled');
            else wrapper.classList.remove('disabled');
        };

        // åˆå§‹åˆ·æ–°
        select.refreshCustomSelect();

        // ç‚¹å‡» Trigger
        trigger.onclick = (e) => {
            if (select.disabled) return;
            e.stopPropagation();
            // å…³é—­å…¶ä»–
            document.querySelectorAll('.custom-select').forEach(s => {
                if (s !== wrapper) s.classList.remove('open');
            });
            wrapper.classList.toggle('open');
            
            // å¦‚æœæ‰“å¼€ï¼Œæ»šåŠ¨åˆ°é€‰ä¸­é¡¹
            if (wrapper.classList.contains('open')) {
                const selected = optionsDiv.querySelector('.selected');
                if (selected) {
                    // ç®€å•çš„æ»šåŠ¨é€»è¾‘
                    optionsDiv.scrollTop = selected.offsetTop - optionsDiv.offsetTop;
                }
            }
        };

        // ç›‘å¬ disabled å±æ€§å˜åŒ–
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
                    select.refreshCustomSelect();
                }
            });
        });
        observer.observe(select, { attributes: true });
    }

    function initCustomSelects() {
        // åªé’ˆå¯¹é…ç½®åŒºåŸŸçš„ Selectï¼Œä¸”æ’é™¤ Input+Datalist (baudInput)
        const selects = document.querySelectorAll('.config-area select'); 
        selects.forEach(setupCustomSelect);
    }

    // å…¨å±€ç‚¹å‡»å…³é—­
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-select')) {
            document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
        }
    });

    function init() {
        const t = getTimestamp();
        document.getElementById('initTimeTx').innerText = t;
        document.getElementById('initTimeRx').innerText = t;
        renderCommands();
        renderThemes();
        applyTheme(currentThemeIdx);
        connectWebSocket();
        initCharts();

        document.addEventListener('click', (e) => {
            if (!dom.themePopover.contains(e.target) && !dom.themeBtn.contains(e.target)) {
                dom.themePopover.style.display = 'none';
            }
        });
        
        // å¯åŠ¨ç»Ÿè®¡å®šæ—¶å™¨ (æ¯ç§’æ›´æ–°é€Ÿç‡å›¾)
        rateInterval = setInterval(updateRateChart, 1000);

        // å…¨å±€å¿«æ·é”®ç›‘å¬
        document.addEventListener('keydown', handleGlobalKeydown);
        // å½•åˆ¶å¿«æ·é”®ç›‘å¬
        document.getElementById('newCmdShortcut').addEventListener('keydown', handleRecorderKeydown);
        
        initCustomSelects();
    }

    function handleGlobalKeydown(e) {
        // å¦‚æœæ­£åœ¨è¾“å…¥ï¼ˆéå¿«æ·é”®å½•åˆ¶æ¡†ï¼‰ï¼Œå¿½ç•¥
        if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName) && document.activeElement.id !== 'newCmdShortcut') return;
        
        // å½•åˆ¶æ¡†ç”±ä¸“ç”¨ç›‘å¬å™¨å¤„ç†
        if (document.activeElement.id === 'newCmdShortcut') return;

        // æ„å»ºå½“å‰æŒ‰é”®ç»„åˆ
        const combo = getComboString(e);
        if (!combo) return;

        const index = savedCommands.findIndex(c => c.shortcut === combo);
        if (index !== -1) {
            e.preventDefault();
            fillAndSend(index);
            // è§†è§‰åé¦ˆ
            const items = document.querySelectorAll('.cmd-item');
            if(items[index]) {
                items[index].style.background = 'rgba(0,113,227,0.1)';
                setTimeout(() => items[index].style.background = '', 200);
            }
        }
    }

    function handleRecorderKeydown(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // å¿½ç•¥å•ç‹¬çš„ä¿®é¥°é”®
        if (['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) return;
        
        const combo = getComboString(e);
        if (combo) {
            e.target.value = combo;
        }
    }

    function getComboString(e) {
        const parts = [];
        if (e.ctrlKey) parts.push('Ctrl');
        if (e.shiftKey) parts.push('Shift');
        if (e.altKey) parts.push('Alt');
        if (e.metaKey) parts.push('Meta');
        
        let key = e.key;
        if (key === ' ') key = 'Space';
        // å¿½ç•¥æ— æ•ˆé”®
        if (['Unidentified'].includes(key)) return null;
        
        // å•å­—æ¯å¤§å†™
        if (key.length === 1) key = key.toUpperCase();
        
        // é¿å…é‡å¤ (å¦‚ Ctrl+Control)
        if (!parts.includes(key)) parts.push(key);
        
        return parts.join('+');
    }

    window.clearShortcut = () => {
        document.getElementById('newCmdShortcut').value = '';
    };

    // --- è§†å›¾åˆ‡æ¢ ---
    window.switchSendTab = (tabName) => {
        const tabs = document.querySelectorAll('.send-tab');
        const contents = document.querySelectorAll('.send-tab-content');
        
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.style.display = 'none');
        
        if (tabName === 'basic') {
            tabs[0].classList.add('active');
            document.getElementById('tab-basic').style.display = 'block';
        } else {
            tabs[1].classList.add('active');
            document.getElementById('tab-protocol').style.display = 'block';
            document.getElementById('tab-protocol').style.height = '100%'; // Fix height
        }
    };

    window.switchView = (viewName) => {
        // æŒ‰é’®çŠ¶æ€
        const buttons = document.querySelectorAll('.view-btn');
        buttons.forEach(btn => btn.classList.remove('active'));
        
        if(viewName === 'main') buttons[0].classList.add('active');
        else if(viewName === 'stats') buttons[1].classList.add('active');
        else if(viewName === 'dashboard') buttons[2].classList.add('active');
        
        // é¡µé¢æ˜¾éš
        const views = document.querySelectorAll('.page-view');
        views.forEach(v => v.classList.remove('active'));
        document.getElementById(`view-${viewName}`).classList.add('active');
        
        // å¦‚æœæ˜¯ç»Ÿè®¡é¡µé¢ï¼Œè§¦å‘å›¾è¡¨é‡ç»˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if(viewName === 'stats' && (!pieChart || !lineChart)) {
            // initCharts(); // å·²ç»åœ¨ init() ä¸­è°ƒç”¨
        }
    };

    // --- ä»ªè¡¨ç›˜é€»è¾‘ ---
    window.toggleLED = (checkbox) => {
        const cmd = checkbox.checked ? "LED:ON" : "LED:OFF";
        const indicator = document.getElementById('ledIndicator');
        if(checkbox.checked) indicator.classList.add('on');
        else indicator.classList.remove('on');
        
        // å‘é€å‘½ä»¤
        sendData(cmd + (dom.isAutoNewline.checked ? '\n' : ''));
        appendLog('Sys', `[Dashboard] Sent: ${cmd}`);
    };

    window.updateIICDisplay = () => {
        const input = document.getElementById('iicInput');
        const val = input.value.padEnd(4, ' ').substring(0, 4);
        
        // æ›´æ–°æ˜¾ç¤º
        for(let i=0; i<4; i++) {
            document.getElementById(`digit-${i}`).innerText = val[i];
        }
        
        const cmd = `DISP:${val}`;
        sendData(cmd + (dom.isAutoNewline.checked ? '\n' : ''));
        appendLog('Sys', `[Dashboard] Sent: ${cmd}`);
    };

    // æ¨¡æ‹Ÿæˆ–è§£ææ¥æ”¶åˆ°çš„ä¼ æ„Ÿå™¨æ•°æ®
    // æ ¼å¼å‡è®¾: SENSOR:sound,moisture,pressure (e.g., SENSOR:45,60,1024)
    function parseSensorData(text) {
        if(text.startsWith('SENSOR:')) {
            const parts = text.substring(7).split(',');
            if(parts.length >= 3) {
                const sound = parseInt(parts[0]);
                const moisture = parseInt(parts[1]);
                const pressure = parseInt(parts[2]);
                
                // æ›´æ–° UI
                if(!isNaN(sound)) {
                    document.getElementById('val-sound').innerText = sound + ' dB';
                    document.getElementById('bar-sound').style.width = Math.min(sound, 100) + '%';
                }
                if(!isNaN(moisture)) {
                    document.getElementById('val-moisture').innerText = moisture + ' %';
                    document.getElementById('bar-moisture').style.width = Math.min(moisture, 100) + '%';
                }
                if(!isNaN(pressure)) {
                    document.getElementById('val-pressure').innerText = pressure;
                    document.getElementById('bar-pressure').style.width = Math.min((pressure/4096)*100, 100) + '%';
                }
            }
        }
        // LED çŠ¶æ€å›ä¼ : LED:ON æˆ– LED:OFF
        if(text.includes('LED:ON')) {
            document.getElementById('ledToggle').checked = true;
            document.getElementById('ledIndicator').classList.add('on');
        } else if(text.includes('LED:OFF')) {
            document.getElementById('ledToggle').checked = false;
            document.getElementById('ledIndicator').classList.remove('on');
        }
    }

    // --- å›¾è¡¨é€»è¾‘ (Chart.js) ---
    function initCharts() {
        // 1. ç¯å½¢å›¾ (æµé‡å æ¯”)
        const ctxPie = document.getElementById('trafficPieChart').getContext('2d');
        pieChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['æ¥æ”¶ (RX)', 'å‘é€ (TX)'],
                datasets: [{
                    data: [0, 0],
                    backgroundColor: ['#4ade80', '#60a5fa'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                cutout: '70%'
            }
        });

        // 2. æŠ˜çº¿å›¾ (å®æ—¶é€Ÿç‡)
        const ctxLine = document.getElementById('rateLineChart').getContext('2d');
        lineChart = new Chart(ctxLine, {
            type: 'line',
            data: {
                labels: [], // æ—¶é—´è½´
                datasets: [
                    {
                        label: 'RX (B/s)',
                        data: [],
                        borderColor: '#4ade80',
                        backgroundColor: 'rgba(74, 222, 128, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'TX (B/s)',
                        data: [],
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                },
                animation: false // å…³é—­åŠ¨ç”»æé«˜æ€§èƒ½
            }
        });
    }

    function updateStatsUI() {
        dom.statRxTotal.innerText = formatBytes(stats.rxBytes);
        dom.statTxTotal.innerText = formatBytes(stats.txBytes);
        dom.statRxPackets.innerText = stats.rxPackets;
        dom.statTxPackets.innerText = stats.txPackets;
        
        // æ›´æ–°ç¯å½¢å›¾
        pieChart.data.datasets[0].data = [stats.rxBytes, stats.txBytes];
        pieChart.update();
    }
    
    function updateRateChart() {
        const now = new Date();
        const timeLabel = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
        
        // ä¿æŒåªæ˜¾ç¤ºæœ€è¿‘ 60 ç§’æ•°æ®
        if (lineChart.data.labels.length > 20) {
            lineChart.data.labels.shift();
            lineChart.data.datasets[0].data.shift();
            lineChart.data.datasets[1].data.shift();
        }
        
        lineChart.data.labels.push(timeLabel);
        lineChart.data.datasets[0].data.push(stats.rxBytesSec);
        lineChart.data.datasets[1].data.push(stats.txBytesSec);
        lineChart.update();
        
        // é‡ç½®ç§’è®¡æ•°å™¨
        stats.rxBytesSec = 0;
        stats.txBytesSec = 0;
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // --- ä¸»é¢˜é€»è¾‘ ---
    dom.themeBtn.onclick = () => {
        dom.themePopover.style.display = dom.themePopover.style.display === 'block' ? 'none' : 'block';
    };

    function renderThemes() {
        dom.themeGrid.innerHTML = '';
        themes.forEach((t, i) => {
            const div = document.createElement('div');
            div.className = `theme-item ${i === currentThemeIdx ? 'active' : ''}`;
            div.style.backgroundColor = t.bg;
            div.title = t.name;
            div.onclick = () => applyTheme(i);
            dom.themeGrid.appendChild(div);
        });
    }

    function applyTheme(index) {
        currentThemeIdx = index;
        const theme = themes[index];
        const root = document.documentElement;
        root.style.setProperty('--bg-color', theme.bg);
        root.style.setProperty('--accent-color', theme.accent);
        document.querySelectorAll('.theme-item').forEach((el, i) => {
            if (i === index) el.classList.add('active');
            else el.classList.remove('active');
        });
        localStorage.setItem('theme_idx', index);
    }

    // --- WebSocket ---
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            appendLog('Sys', 'WebSocket æœåŠ¡å·²è¿æ¥');
            ws.send(JSON.stringify({ cmd: "update_config", isHexShow: dom.isHexShow.checked, rxEncoding: dom.rxEncoding.value }));
        };
        ws.onclose = () => {
            appendLog('Err', 'è¿æ¥æ–­å¼€ï¼Œæ­£åœ¨å°è¯•é‡è¿...');
            isConnected = false;
            updateUIState(false);
            setTimeout(connectWebSocket, 3000);
        };
        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'ports') updatePortList(msg.data);
            else if (msg.type === 'rx') handleRxData(msg.data);
            else if (msg.type === 'status') {
                const nextConnected = (typeof msg.connected === 'boolean') ? msg.connected : !!msg.success;
                isConnected = nextConnected;
                updateUIState(nextConnected);
                appendLog(msg.success ? 'Sys' : 'Err', msg.msg);
            } else if (msg.type === 'error') appendLog('Err', msg.msg);
        };
    }

    function updatePortList(ports) {
        const current = dom.ports.value;
        dom.ports.innerHTML = '';
        ports.forEach(port => {
            const opt = document.createElement('option');
            opt.value = port;
            opt.text = port;
            dom.ports.appendChild(opt);
        });
        if (current && ports.includes(current)) dom.ports.value = current;
        if (dom.ports.refreshCustomSelect) dom.ports.refreshCustomSelect();
    }

    function isProbablyHexBytesString(str) {
        if (typeof str !== 'string') return false;
        const s = str.trim();
        return s.length > 0 && /^([0-9a-fA-F]{2})(\s+[0-9a-fA-F]{2})*$/.test(s);
    }

    function handleRxData(data) {
        // å°è¯•è§£æä¼ æ„Ÿå™¨æ•°æ® (ä»ªè¡¨ç›˜æ›´æ–°)
        try { parseSensorData(data); } catch(e) { console.log('Parse Error', e); }

        // ç»Ÿè®¡æ›´æ–°
        const byteLen = data.length; // ç®€å•æŒ‰å­—ç¬¦é•¿åº¦è®¡ç®—ï¼Œç²¾ç¡®éœ€åç«¯ä¼ å­—èŠ‚é•¿åº¦
        stats.rxBytes += byteLen;
        stats.rxBytesSec += byteLen;
        stats.rxPackets++;
        updateStatsUI();
        
        let displayData = data;
        if (dom.isHexShow.checked) {
            displayData = isProbablyHexBytesString(data) ? data.replace(/\s+/g, ' ').trim().toUpperCase() : stringToHex(data);
            
            // åˆ†åŒ…å¤„ç†
            const packetSplit = document.getElementById('rxPacketSplit').checked;
            const header = document.getElementById('rxFrameHeader').value.trim().toUpperCase();
            const tail = document.getElementById('rxFrameTail').value.trim().toUpperCase();
            
            if (packetSplit && (header || tail)) {
                // ç§»é™¤æ‰€æœ‰ç©ºæ ¼ä»¥ä¾¿åŒ¹é…
                let cleanHex = displayData.replace(/\s+/g, '');
                
                // ä½¿ç”¨å”¯ä¸€çš„åˆ†éš”ç¬¦æ ‡è®°åˆ†å‰²ç‚¹
                // ç­–ç•¥ï¼šå°† Header æ›¿æ¢ä¸º "|Header"ï¼Œå°† Tail æ›¿æ¢ä¸º "Tail|"
                let processed = cleanHex;
                if (header) processed = processed.split(header).join('|' + header);
                if (tail) processed = processed.split(tail).join(tail + '|');
                
                // åˆ†å‰²å¹¶è¿‡æ»¤ç©ºè¡Œ
                const parts = processed.split('|').filter(p => p && p.trim().length > 0);
                
                // å¯¹æ¯ä¸€éƒ¨åˆ†åˆ†åˆ«æ ¼å¼åŒ–å¹¶è¾“å‡ºæ—¥å¿—
                parts.forEach(part => {
                    // é‡æ–°æ ¼å¼åŒ–ä¸º HEX (AA BB CC)
                    // ä½¿ç”¨ match(/.{1,2}/g) æ¯ä¸¤ä¸ªå­—ç¬¦ä¸€ç»„
                    let formatted = part.match(/.{1,2}/g)?.join(' ') || part;
                    appendLog('RX', formatted);
                });
                
                return; // å·²å¤„ç†ï¼Œç›´æ¥è¿”å›ï¼Œä¸å†æ‰§è¡Œåç»­çš„å•æ¬¡ appendLog
            }
        }
        
        appendLog('RX', displayData);
        
        // å°è¯•è§£æåè®®å¸§ (ä»…åœ¨åè®®Tabæ¿€æ´»ä¸”æ•°æ®çœ‹èµ·æ¥åƒHexæ—¶)
        if (document.getElementById('tab-protocol').style.display !== 'none') {
            tryParseProtocol(data);
        }
    }

    function tryParseProtocol(raw) {
        // 1. å°è¯•å°†è¾“å…¥è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
        let bytes = [];
        // å¦‚æœåç«¯å‘æ¥çš„æ˜¯ "AA BB CC" è¿™ç§ Hex å­—ç¬¦ä¸² (hexShow mode)
        if (/^([0-9a-fA-F]{2}\s?)+$/.test(raw)) {
             raw.split(/\s+/).forEach(h => {
                 if(h) bytes.push(parseInt(h, 16));
             });
        } else {
            // å°è¯•å°†å­—ç¬¦ä¸²è½¬å­—èŠ‚
            for (let i = 0; i < raw.length; i++) bytes.push(raw.charCodeAt(i) & 0xFF);
        }
        
        // åè®®æœ€å°é•¿åº¦: Addr(1)+Func(1)+Len(1)+Seq(1)+Check(1) = 5
        if (bytes.length < 5) return;
        
        // ç®€å•å¯»æ‰¾å¯èƒ½çš„å¸§ (å‡è®¾ç¬¬ä¸€å­—èŠ‚æ˜¯ Addr, ä¸”é•¿åº¦ç¬¦åˆ)
        // å®é™…ä¸Šè¿™å¾ˆè„†å¼±ï¼Œä½†åœ¨ç®€å•å·¥å…·ä¸­å¯ä»¥æ¥å—
        // æ ¼å¼: [Addr] [Func] [Len] [Seq] [Data...] [Check]
        
        const len = bytes[2];
        if (bytes.length < 4 + len + 1) return; // é•¿åº¦ä¸è¶³
        
        const addr = bytes[0];
        const func = bytes[1];
        const seq = bytes[3];
        const dataBytes = bytes.slice(4, 4 + len);
        const checkReceived = bytes[4 + len];
        
        // æ ¡éªŒè®¡ç®— (å°è¯• SUM)
        const frameNoCheck = bytes.slice(0, 4 + len);
        const sum = frameNoCheck.reduce((a,b)=>a+b,0) % 256;
        
        // æ›´æ–° UI
        document.getElementById('rxAddr').value = addr.toString(16).toUpperCase().padStart(2,'0');
        document.getElementById('rxFunc').value = func.toString(16).toUpperCase().padStart(2,'0');
        document.getElementById('rxLen').value = len;
        document.getElementById('rxSeq').value = seq;
        
        // ç®€å•çš„æ ¡éªŒæŒ‡ç¤º
        const checkDisplay = checkReceived.toString(16).toUpperCase().padStart(2,'0');
        document.getElementById('rxCheck').value = checkDisplay + (sum === checkReceived ? ' (OK)' : ' (!)');
        
        // è§£ææ•°æ®åŒº
        document.getElementById('rxParsedResult').value = dataBytes.map(b=>b.toString(16).padStart(2,'0')).join(' ');
    }


    dom.connectBtn.onclick = () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) return;
        if (isConnected) {
            ws.send(JSON.stringify({ cmd: "disconnect" }));
        } else {
            const port = dom.ports.value;
            const baud = parseInt(dom.baud.value); 
            if (!port) return alert("è¯·é€‰æ‹©ç«¯å£");
            if (isNaN(baud)) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„æ³¢ç‰¹ç‡");
            ws.send(JSON.stringify({ 
                cmd: "connect", 
                port: port, 
                baud: baud,
                bytesize: dom.dataBits.value,
                stopbits: dom.stopBits.value,
                parity: dom.parity.value,
                flow_control: dom.flowControl.value
            }));
        }
    };

    dom.isHexShow.onchange = () => {
        if(ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ cmd: "update_config", isHexShow: dom.isHexShow.checked, rxEncoding: dom.rxEncoding.value }));
        }
    };

    dom.rxEncoding.onchange = () => {
        if(ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ cmd: "update_config", rxEncoding: dom.rxEncoding.value }));
        }
    };

    dom.sendBtn.onclick = sendData;

    function sendData() {
        if (!isConnected) return appendLog('Err', 'è®¾å¤‡æœªè¿æ¥');
        let text = dom.input.value;
        if (!text) return;

        const isHex = dom.isHex.checked;
        if (dom.isAutoNewline.checked && !isHex) text += "\r\n";

        // ç»Ÿè®¡æ›´æ–°
        const byteLen = text.length;
        stats.txBytes += byteLen;
        stats.txBytesSec += byteLen;
        stats.txPackets++;
        updateStatsUI();

        ws.send(JSON.stringify({ cmd: "send", data: text, isHex: isHex }));
        appendLog('TX', isHex ? `[HEX] ${text}` : text);
    }

    dom.autoSendBtn.onclick = () => {
        if (autoSendTimer) {
            clearInterval(autoSendTimer);
            autoSendTimer = null;
            dom.autoSendBtn.textContent = "å¾ªç¯å‘é€";
            dom.autoSendBtn.style.background = "";
            dom.autoSendBtn.style.color = "";
        } else {
            if (!isConnected) return appendLog('Err', 'è¯·å…ˆè¿æ¥ä¸²å£');
            const interval = parseInt(dom.interval.value) || 1000;
            sendData();
            autoSendTimer = setInterval(sendData, interval);
            dom.autoSendBtn.textContent = "åœæ­¢å‘é€";
            dom.autoSendBtn.style.background = "#ff3b30";
            dom.autoSendBtn.style.color = "white";
        }
    };

    // --- æ¯«ç§’çº§æ—¶é—´æˆ³ ---
    function getTimestamp() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        const ms = String(now.getMilliseconds()).padStart(3, '0');
        return `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}.${ms}`;
    }

    function appendLog(type, content) {
        const div = document.createElement('div');
        let typeClass = 'type-sys';
        let icon = '';
        let targets = []; // ç›®æ ‡æ—¥å¿—çª—å£æ•°ç»„

        // æ±‰åŒ–æç¤º
        let displayType = type;
        if(type === 'RX') { 
            typeClass = 'type-rx'; 
            icon = 'â†“'; // æ›´ç›´è§‚çš„æ¥æ”¶å›¾æ ‡
            targets = [dom.logRx];
        }
        else if(type === 'TX') { 
            typeClass = 'type-tx'; 
            icon = 'â†‘'; // æ›´ç›´è§‚çš„å‘é€å›¾æ ‡
            targets = [dom.logTx];
        }
        else if(type === 'Err') { 
            typeClass = 'type-err'; 
            icon = 'âš ï¸'; 
            displayType = 'é”™è¯¯'; 
            targets = [dom.logRx, dom.logTx]; // é”™è¯¯åŒæ—¶æ˜¾ç¤ºåœ¨ä¸¤è¾¹
        }
        else { 
            icon = 'â„¹'; 
            displayType = 'ç³»ç»Ÿ'; 
            targets = [dom.logRx, dom.logTx]; // ç³»ç»Ÿæ¶ˆæ¯åŒæ—¶æ˜¾ç¤ºåœ¨ä¸¤è¾¹
        }

        div.className = `log-line ${typeClass}`;
        // ç§»é™¤å¤šä½™çš„ç¼©è¿› spanï¼Œå› ä¸º flex å¸ƒå±€ä¸‹ log-content å·²ç»ç‹¬ç«‹ä¸€åˆ—
        const safeContent = content.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>'); 
        
        // æ–°çš„ HTML ç»“æ„ï¼Œåˆ†ç¦»æ—¶é—´ã€å›¾æ ‡å’Œå†…å®¹ï¼Œå®ç°å®Œç¾å¯¹é½
        div.innerHTML = `<span class="log-time">${getTimestamp()}</span><span class="log-icon">${icon}</span><span class="log-content">${safeContent}</span>`;
        
        // éå†ç›®æ ‡çª—å£è¿›è¡Œè¿½åŠ 
        targets.forEach(targetLog => {
            if (!targetLog) return;
            const logItem = div.cloneNode(true);
            targetLog.appendChild(logItem);
            targetLog.scrollTop = targetLog.scrollHeight;
            if (targetLog.childElementCount > 1000) targetLog.removeChild(targetLog.firstChild);
        });
    }

    function updateUIState(connected) {
        if (connected) {
            dom.connectBtn.textContent = "æ–­å¼€è¿æ¥";
            dom.connectBtn.style.backgroundColor = "#ff3b30";
            dom.statusDot.classList.replace('disconnected', 'connected');
            dom.ports.disabled = true;
            dom.baud.disabled = true;
            dom.dataBits.disabled = true;
            dom.stopBits.disabled = true;
            dom.parity.disabled = true;
            dom.flowControl.disabled = true;
        } else {
            dom.connectBtn.textContent = "è¿æ¥è®¾å¤‡";
            dom.connectBtn.style.backgroundColor = "";
            dom.statusDot.classList.replace('connected', 'disconnected');
            dom.ports.disabled = false;
            dom.baud.disabled = false;
            dom.dataBits.disabled = false;
            dom.stopBits.disabled = false;
            dom.parity.disabled = false;
            dom.flowControl.disabled = false;
            if (autoSendTimer) dom.autoSendBtn.click();
            if (typeof protoAutoSendTimer !== 'undefined' && protoAutoSendTimer) {
                clearInterval(protoAutoSendTimer);
                protoAutoSendTimer = null;
                const auto = document.getElementById('protoAutoSend');
                if (auto) auto.checked = false;
            }
        }
    }

    function stringToHex(str) {
        let hex = '';
        for(let i=0;i<str.length;i++) hex += str.charCodeAt(i).toString(16).padStart(2, '0').toUpperCase() + ' ';
        return hex;
    }

    window.clearLog = () => {
        dom.logTx.innerHTML = '';
        dom.logRx.innerHTML = '';
    };

    window.togglePacketConfig = () => {
        const panel = document.getElementById('packetConfigPanel');
        panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
    };
    
    // --- å¿«æ·æŒ‡ä»¤ ---
    function renderCommands() {
        dom.cmdList.innerHTML = '';
        if (savedCommands.length === 0) {
            dom.cmdList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-top: 40px;">æš‚æ— æŒ‡ä»¤</div>';
            return;
        }
        savedCommands.forEach((cmd, index) => {
            const div = document.createElement('div');
            div.className = 'cmd-item';
            div.innerHTML = `
                <div class="cmd-info" onclick="fillAndSend(${index})">
                    <div class="cmd-name">
                        ${cmd.name}
                        ${cmd.shortcut ? `<span class="cmd-shortcut">${cmd.shortcut}</span>` : ''}
                    </div>
                    <div class="cmd-val">${cmd.isHex ? '[HEX] ' : ''}${cmd.data}</div>
                </div>
                <button class="cmd-del" onclick="deleteCmd(event, ${index})">âœ•</button>
            `;
            dom.cmdList.appendChild(div);
        });
    }

    window.fillAndSend = (index) => {
        const cmd = savedCommands[index];
        dom.input.value = cmd.data;
        dom.isHex.checked = cmd.isHex;
        sendData();
    };

    window.deleteCmd = (e, index) => {
        e.stopPropagation();
        if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤æŒ‡ä»¤å—ï¼Ÿ')) {
            savedCommands.splice(index, 1);
            saveToLocal();
            renderCommands();
            renderManagerList();
        }
    };
    
    function saveToLocal() {
        localStorage.setItem('serial_cmds', JSON.stringify(savedCommands));
    }

    // --- æŒ‡ä»¤ç®¡ç†å™¨ ---
    window.openCmdManager = () => {
        renderManagerList();
        document.getElementById('cmdManagerModal').style.display = 'flex';
    };

    function renderManagerList() {
        const list = document.getElementById('mgrList');
        list.innerHTML = '';
        if (savedCommands.length === 0) {
            list.innerHTML = '<div style="text-align: center; color: var(--text-secondary); margin-top: 40px;">æš‚æ— æŒ‡ä»¤</div>';
            return;
        }
        
        savedCommands.forEach((cmd, index) => {
            const div = document.createElement('div');
            div.className = 'mgr-item';
            div.innerHTML = `
                <div class="mgr-item-info">
                    <div class="mgr-item-name">
                        ${cmd.name}
                        ${cmd.shortcut ? `<span class="cmd-shortcut">${cmd.shortcut}</span>` : ''}
                    </div>
                    <div class="mgr-item-val">${cmd.isHex ? '[HEX] ' : ''}${cmd.data}</div>
                </div>
                <div class="mgr-btn-group">
                    <button class="btn-secondary btn-sm" onclick="openEditCmdModal(${index})">ç¼–è¾‘</button>
                    <button class="btn-secondary btn-sm btn-danger" onclick="deleteCmd(event, ${index})">åˆ é™¤</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // --- å¯¼å…¥å¯¼å‡º ---
    window.exportCommands = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(savedCommands, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "serial_commands.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    };

    window.importCommands = () => {
        document.getElementById('importFile').click();
    };

    window.handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if (Array.isArray(imported)) {
                    // åˆå¹¶å»é‡
                    const currentNames = new Set(savedCommands.map(c => c.name));
                    let addedCount = 0;
                    imported.forEach(cmd => {
                        if (cmd.name && cmd.data && !currentNames.has(cmd.name)) {
                            savedCommands.push(cmd);
                            addedCount++;
                        }
                    });
                    saveToLocal();
                    renderCommands();
                    renderManagerList();
                    alert(`æˆåŠŸå¯¼å…¥ ${addedCount} æ¡æ–°æŒ‡ä»¤`);
                } else {
                    alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šå¿…é¡»æ˜¯æŒ‡ä»¤æ•°ç»„');
                }
            } catch (err) {
                alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®');
            }
            // æ¸…ç©º input å…è®¸å†æ¬¡é€‰æ‹©åŒä¸€æ–‡ä»¶
            event.target.value = '';
        };
        reader.readAsText(file);
    };

    window.openAddCmdModal = () => {
        document.getElementById('modalTitle').innerText = 'æ–°æŒ‡ä»¤';
        document.getElementById('newCmdName').value = '';
        document.getElementById('newCmdData').value = '';
        document.getElementById('newCmdShortcut').value = '';
        document.getElementById('newCmdHex').checked = false;
        document.getElementById('editCmdIndex').value = '-1';
        document.getElementById('addCmdModal').style.display = 'flex';
    };
    
    window.openEditCmdModal = (index) => {
        const cmd = savedCommands[index];
        document.getElementById('modalTitle').innerText = 'ç¼–è¾‘æŒ‡ä»¤';
        document.getElementById('newCmdName').value = cmd.name;
        document.getElementById('newCmdData').value = cmd.data;
        document.getElementById('newCmdShortcut').value = cmd.shortcut || '';
        document.getElementById('newCmdHex').checked = cmd.isHex || false;
        document.getElementById('editCmdIndex').value = index;
        document.getElementById('addCmdModal').style.display = 'flex';
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    
    window.saveCommand = () => {
        const name = document.getElementById('newCmdName').value;
        const data = document.getElementById('newCmdData').value;
        const shortcut = document.getElementById('newCmdShortcut').value;
        const isHex = document.getElementById('newCmdHex').checked;
        const index = parseInt(document.getElementById('editCmdIndex').value);
        
        if(!name || !data) return alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        
        const newCmd = { name, data, isHex, shortcut };
        
        if (index >= 0) {
            // ç¼–è¾‘æ¨¡å¼
            savedCommands[index] = newCmd;
        } else {
            // æ–°å¢æ¨¡å¼
            savedCommands.push(newCmd);
        }
        
        saveToLocal();
        document.getElementById('newCmdName').value = '';
        document.getElementById('newCmdData').value = '';
        document.getElementById('newCmdShortcut').value = '';
        closeModal('addCmdModal');
        renderCommands();
        // å¦‚æœç®¡ç†å™¨æ‰“å¼€ï¼Œä¹Ÿåˆ·æ–°å®ƒ
        if(document.getElementById('cmdManagerModal').style.display === 'flex') {
            renderManagerList();
        }
    };

    // --- åè®®ä¼ è¾“é€»è¾‘ ---
    let protoAutoSendTimer = null;

    function getProtocolFrame() {
        // 1. è·å–å‚æ•°
        const addrStr = document.getElementById('txAddr').value || '00';
        const funcStr = document.getElementById('txFunc').value || '00';
        const seqStr = document.getElementById('txSeq').value || '0';
        const dataStr = document.getElementById('txData').value || '';
        const checkMode = document.getElementById('txCheckMode').value;

        // 2. è§£æ
        const addr = parseInt(addrStr, 16) & 0xFF;
        const func = parseInt(funcStr, 16) & 0xFF;
        const seq = parseInt(seqStr, 10) & 0xFF;
        
        let dataBytes = [];
        if (dataStr.trim()) {
            dataStr.split(/\s+/).forEach(s => {
                if(s) dataBytes.push(parseInt(s, 16) & 0xFF);
            });
        }
        const len = dataBytes.length;

        // 3. æ„å»ºå¸§å¤´ (ä¸å«æ ¡éªŒ)
        // [Addr] [Func] [Len] [Seq] [Data...]
        const frame = [addr, func, len, seq, ...dataBytes];

        // 4. è®¡ç®—æ ¡éªŒ
        let check = 0;
        if (checkMode === 'sum') {
            check = frame.reduce((a, b) => a + b, 0) % 256;
        } else if (checkMode === 'xor') {
            check = frame.reduce((a, b) => a ^ b, 0);
        } else if (checkMode === 'crc8') {
            // ç®€å•çš„ CRC8 å®ç° (Poly: 0x07)
            check = 0;
            frame.forEach(b => {
                check ^= b;
                for (let i = 0; i < 8; i++) {
                    if (check & 0x80) check = (check << 1) ^ 0x07;
                    else check <<= 1;
                }
                check &= 0xFF;
            });
        }

        frame.push(check);
        return frame;
    }

    function sendProtocol() {
        if (!isConnected) return appendLog('Err', 'è®¾å¤‡æœªè¿æ¥');
        
        const frame = getProtocolFrame();
        // è½¬ä¸º Hex å­—ç¬¦ä¸²å‘é€ (åç«¯æ”¯æŒ Hex æ¨¡å¼)
        const hexStr = frame.map(b => b.toString(16).padStart(2, '0').toUpperCase()).join('');
        
        // ç»Ÿè®¡æ›´æ–°
        const byteLen = frame.length;
        stats.txBytes += byteLen;
        stats.txBytesSec += byteLen;
        stats.txPackets++;
        updateStatsUI();

        ws.send(JSON.stringify({ cmd: "send", data: hexStr, isHex: true }));
        appendLog('TX', `[PROTO] ${hexStr.replace(/(.{2})/g, '$1 ')}`);
        
        // åºåˆ—å·è‡ªåŠ¨é€’å¢
        const seqInput = document.getElementById('txSeq');
        let seq = parseInt(seqInput.value) || 0;
        seq = (seq + 1) % 256;
        seqInput.value = seq;
    }

    // ç»‘å®šåè®®å‘é€æŒ‰é’®
    document.getElementById('protoSendBtn').onclick = () => {
        const isLoop = document.getElementById('protoAutoSend').checked;
        const btn = document.getElementById('protoSendBtn');
        
        if (protoAutoSendTimer) {
            // åœæ­¢å¾ªç¯
            clearInterval(protoAutoSendTimer);
            protoAutoSendTimer = null;
            btn.textContent = "å‘é€";
            btn.style.backgroundColor = "";
        } else {
            if (isLoop) {
                // å¼€å§‹å¾ªç¯
                if (!isConnected) return appendLog('Err', 'è®¾å¤‡æœªè¿æ¥');
                const interval = parseInt(document.getElementById('protoInterval').value) || 1000;
                sendProtocol(); // ç«‹å³å‘é€ä¸€æ¬¡
                protoAutoSendTimer = setInterval(sendProtocol, interval);
                btn.textContent = "åœæ­¢";
                btn.style.backgroundColor = "#ff3b30";
            } else {
                // å•æ¬¡å‘é€
                sendProtocol();
            }
        }
    };
    
    // å¦‚æœå–æ¶ˆå‹¾é€‰å¾ªç¯ï¼Œè‡ªåŠ¨åœæ­¢
    document.getElementById('protoAutoSend').onchange = (e) => {
        if (!e.target.checked && protoAutoSendTimer) {
            clearInterval(protoAutoSendTimer);
            protoAutoSendTimer = null;
            const btn = document.getElementById('protoSendBtn');
            btn.textContent = "å‘é€";
            btn.style.backgroundColor = "";
        }
    };

    init();
</script>
</body>
</html>
